<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>イラストアーカイブ v0.6</title>

<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 16px;
}

h1 { font-size: 20px; }

/* 入力欄横並び */
.input-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 10px;
}
.input-row input,
.input-row select,
.input-row button {
  width: calc(50% - 6px);
  box-sizing: border-box;
}

/* 一覧画面 */
#list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 8px;
}

.card img {
  width: 100%;
  display: block;
  cursor: pointer;
}

.author {
  font-weight: bold;
  font-size: 12px;
  opacity: 0.7;
  margin-top: 2px;
}

/* モーダル */
#modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 999;
}

#modalContent {
  background: #fff;
  padding: 10px;
  max-width: 95%;
  max-height: 95%;
  overflow: hidden;
  position: relative;
}

#modalImage {
  max-width: 100%;
  max-height: 80vh;
  display: block;
  margin: 0 auto;
  cursor: grab;
  user-select: none;
  touch-action: none;
}

#modalTags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin: 6px 0;
}

.tag {
  font-size: 11px;
  padding: 2px 6px;
  border: 1px solid #888;
  border-radius: 6px;
  cursor: pointer;
}
.tag.active { background: #ddd; }
</style>
</head>

<body>

<h1>イラストアーカイブ</h1>

<div class="input-row">
  <input type="file" id="imageInput" accept="image/*">
  <input type="text" id="urlInput" placeholder="元ツイートURL">
  <input type="text" id="authorInput" placeholder="作者名">
  <input type="text" id="tagInput" placeholder="タグ（カンマ区切り）">
  <select id="genreSelect">
    <option value="">ジャンル</option>
    <option value="ファンタジー">ファンタジー</option>
    <option value="日常">日常</option>
  </select>
  <select id="styleSelect">
    <option value="">作風</option>
    <option value="アニメ風">アニメ風</option>
    <option value="リアル">リアル</option>
  </select>
  <select id="partSelect">
    <option value="">パーツ</option>
    <option value="キャラクター">キャラクター</option>
    <option value="背景">背景</option>
  </select>
  <button onclick="addItem()">追加</button>
</div>

<select id="sortSelect" onchange="render()">
  <option value="new">新しい順</option>
  <option value="old">古い順</option>
  <option value="fav">お気に入り優先</option>
</select>

<h3>タグ</h3>
<div id="tags"></div>

<h3>一覧</h3>
<div id="list"></div>

<!-- モーダル -->
<div id="modal">
  <div id="modalContent">
    <button onclick="closeModal()">×</button>
    <img id="modalImage">
    ⭐ <button id="favBtn"></button>
    <div>
      <label>作者</label>
    </div>
    <input type="text" id="editAuthor" placeholder="作者名を編集">
    <h4>タグ</h4>
    <div id="modalTags"></div>
    <input type="text" id="modalTagInput" placeholder="Enterでタグ追加">
    <button id="openUrlBtn">元ツイートを見る</button>
    <button id="deleteBtn">削除</button>
  </div>
</div>

<script>
/* IndexedDB */
let db;
const req = indexedDB.open("artDB",1);
req.onupgradeneeded = e => db = e.target.result, db.createObjectStore("arts",{keyPath:"id"});
req.onsuccess = e => (db=e.target.result, loadAll());

let items=[], activeTag=null, activeAuthor=null, currentItem=null;

function saveItem(item){ db.transaction("arts","readwrite").objectStore("arts").put(item); }
function deleteItem(id){ db.transaction("arts","readwrite").objectStore("arts").delete(id); }
function loadAll(){ db.transaction("arts","readonly").objectStore("arts").getAll().onsuccess = e => (items=e.target.result, render()); }

function addItem(){
  const file=imageInput.files[0];
  if(!file) return alert("画像を選択してください");
  const reader=new FileReader();
  reader.onload=()=>{
    const item={id:Date.now(), image:reader.result, url:urlInput.value, author:authorInput.value, tags:tagInput.value.split(",").map(t=>t.trim()).filter(Boolean), favorite:false};
    items.unshift(item);
    saveItem(item);
    imageInput.value=urlInput.value=authorInput.value=tagInput.value="";
    render();
  };
  reader.readAsDataURL(file);
}

function render(){
  renderTags();
  renderList();
}

function renderTags(){
  tags.innerHTML="";
  [...new Set(items.flatMap(i=>i.tags))].forEach(t=>{
    const s=document.createElement("span");
    s.className="tag"+(t===activeTag?" active":"");
    s.textContent=t;
    s.onclick=()=>{activeTag=activeTag===t?null:t;activeAuthor=null;render();}
    tags.appendChild(s);
  });
}

function renderList(){
  list.innerHTML="";
  let filtered = items.filter(i=>(!activeTag||i.tags.includes(activeTag))&&(!activeAuthor||i.author===activeAuthor));
  if(sortSelect.value==="old") filtered=[...filtered].reverse();
  if(sortSelect.value==="fav") filtered=[...filtered].sort((a,b)=>b.favorite-a.favorite);
  filtered.forEach(i=>{
    const img=document.createElement("img");
    img.src=i.image;
    img.onclick=()=>openModal(i);
    const author=document.createElement("div");
    author.className="author"; author.textContent=i.author||"";
    const div=document.createElement("div"); div.className="card"; div.append(img,author);
    list.appendChild(div);
  });
}

/* モーダル */
function openModal(item){
  currentItem=item;
  modal.style.display="flex";
  modalImage.src=item.image;
  favBtn.textContent=item.favorite?"解除":"お気に入り";
  favBtn.onclick=()=>{item.favorite=!item.favorite;saveItem(item);openModal(item);render();}
  editAuthor.value=item.author;
  editAuthor.onchange=()=>{item.author=editAuthor.value;saveItem(item);render();}
  renderModalTags();
  openUrlBtn.onclick=()=>{if(item.url) window.open(item.url);}
  deleteBtn.onclick=()=>{if(confirm("削除する？")){deleteItem(item.id);items=items.filter(x=>x.id!==item.id);closeModal();render();}}
  /* モーダルズーム＋ドラッグ */
  let scale=1, posX=0, posY=0, startX=0, startY=0, dragging=false;
  modalImage.style.transform=`translate(0px,0px) scale(1)`;
  modalImage.onpointerdown=e=>{dragging=true;startX=e.clientX-posX;startY=e.clientY-posY;modalImage.setPointerCapture(e.pointerId);}
  modalImage.onpointermove=e=>{if(dragging){posX=e.clientX-startX;posY=e.clientY-startY;modalImage.style.transform=`translate(${posX}px,${posY}px) scale(${scale})`;}}
  modalImage.onpointerup=modalImage.onpointercancel=e=>{dragging=false;}
  modalImage.ondblclick=()=>{scale=scale===1?2:1; modalImage.style.transform=`translate(${posX}px,${posY}px) scale(${scale})`;}
}

function renderModalTags(){
  modalTags.innerHTML="";
  if(!currentItem||!currentItem.tags) return;
  currentItem.tags.forEach(t=>{
    const s=document.createElement("span"); s.className="tag"; s.textContent=t;
    s.onclick=()=>{if(confirm(`タグ「${t}」を削除しますか？`)){currentItem.tags=currentItem.tags.filter(x=>x!==t);saveItem(currentItem);renderModalTags();render();}}
    modalTags.appendChild(s);
  });
}

modalTagInput.onkeydown=e=>{if(e.key==="Enter"){const t=modalTagInput.value.trim();if(t&&!currentItem.tags.includes(t)){currentItem.tags.push(t);saveItem(currentItem);renderModalTags();render();}modalTagInput.value="";}}
function closeModal(){modal.style.display="none";currentItem=null;}
modal.addEventListener("click",e=>{if(e.target===modal) closeModal();});
document.addEventListener("keydown",e=>{if(e.key==="Escape"&&modal.style.display==="flex") closeModal();});
render();
</script>
</body>
</html>
