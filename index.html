<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>イラストアーカイブ v0.6</title>

<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body { font-family: system-ui, sans-serif; margin:16px; }
h1{ font-size:20px; }

input, select, button { width:100%; box-sizing:border-box; margin-bottom:6px; }
#list{ display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:12px; }
.card img{ width:100%; display:block; cursor:pointer; }
.card{ padding-bottom:4px; }
.card .author{ font-size:10px; opacity:0.7; }
.card .state{ font-size:10px; padding:1px 4px; border-radius:4px; background:orange; color:#fff; margin-top:2px; display:inline-block; }

.tag{ font-size:11px; padding:2px 6px; border:1px solid #888; border-radius:6px; cursor:pointer; margin:1px; }
.tag.active{ background:#ddd; }

#modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:999; }
#modalContent{ background:#fff; padding:10px; max-width:90%; max-height:90%; overflow:auto; position:relative; }
#modalImage{ max-width:100%; max-height:60vh; display:block; margin-bottom:8px; cursor:grab; }
#modalTags{ display:flex; flex-wrap:wrap; gap:4px; margin-bottom:4px; }
#notification{ position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:6px 12px; border-radius:6px; display:none; opacity:0.9; }
#breadcrumbs{ font-size:12px; margin-bottom:4px; color:#555; }

/* 入力欄を縦一列にする */
.input-row {
  display: flex;
  flex-direction: column; /* 縦に並べる */
  gap: 6px;               /* 各要素の間隔 */
  margin-bottom: 12px;
}

.input-row input,
.input-row select,
.input-row button {
  width: 100%;     /* 画面幅いっぱい */
  box-sizing: border-box;
}

</style>
</head>
<body>

<h1>イラストアーカイブ</h1>

<div class="input-row">
  <input type="file" id="imageInput" accept="image/*">
  <input type="text" id="urlInput" placeholder="元ツイートURL">
  <input type="text" id="authorInput" placeholder="作者名">
  <input type="text" id="tagInput" placeholder="タグ（カンマ区切り）">
  
  <select id="groupSelect">
    <option value="genre">ジャンル</option>
    <option value="style">作風</option>
    <option value="parts">パーツ</option>
  </select>
  
  <select id="stateSelect">
    <option value="">状態なし</option>
    <option value="完成">完成</option>
    <option value="塗り">塗り</option>
    <option value="線画">線画</option>
    <option value="ラフ">ラフ</option>
    <option value="構想">構想</option>
  </select>
  
  <button onclick="addItem()">追加</button>
  
</div>
  
<select id="sortSelect" onchange="render()">
  <option value="new">新しい順</option>
  <option value="old">古い順</option>
  <option value="fav">お気に入り優先</option>
</select>

<h3>タグ</h3>
<div id="tags"></div>

<h3>一覧</h3>
<div id="list"></div>

<!-- モーダル -->
<div id="modal">
  <div id="modalContent">
    <div id="breadcrumbs"></div>
    <button onclick="closeModal()">×</button>
    <img id="modalImage">
    ⭐ <button id="favBtn"></button>
    <div>
      <label>作者</label>
      <input type="text" id="editAuthor">
    </div>

    <div>
      <label>状態タグ</label>
      <select id="modalState"></select>
    </div>

    <h4>タグ</h4>
    <div id="modalTags"></div>
    <input type="text" id="modalTagInput" placeholder="Enterでタグ追加">

    <button id="openUrlBtn">元ツイートを見る</button>
    <button id="deleteBtn">削除</button>
  </div>
</div>

<div id="notification"></div>

<script>
let db;
let items=[], currentItem=null, modalHistory=[];
const req = indexedDB.open("artDB",1);
req.onupgradeneeded = e => { db=e.target.result; db.createObjectStore("arts",{keyPath:"id"}); };
req.onsuccess = e=>{ db=e.target.result; loadAll(); };

function saveItem(item){ db.transaction("arts","readwrite").objectStore("arts").put(item); }
function deleteItem(id){ db.transaction("arts","readwrite").objectStore("arts").delete(id); }
function loadAll(){ db.transaction("arts","readonly").objectStore("arts").getAll().onsuccess=e=>{ items=e.target.result; render(); }; }

function addItem(){
  const file=imageInput.files[0]; if(!file)return alert("画像を選択してください");
  const reader=new FileReader();
  reader.onload=()=>{
    const item={ id:Date.now(), image:reader.result, url:urlInput.value, author:authorInput.value, tags:tagInput.value.split(",").map(t=>t.trim()).filter(Boolean), favorite:false, state:stateSelect.value, group:groupSelect.value, date:new Date().toLocaleDateString(), related:[] };
    items.unshift(item); saveItem(item);
    imageInput.value=urlInput.value=authorInput.value=tagInput.value="";
    render();
  };
  reader.readAsDataURL(file);
}

function render(){
  renderTags();
  renderList();
}

function renderTags(){
  tags.innerHTML="";
  [...new Set(items.flatMap(i=>i.tags))].forEach(t=>{
    const s=document.createElement("span");
    s.className="tag"+(t===activeTag?" active":"");
    s.textContent=t;
    s.onclick=()=>{ activeTag=activeTag===t?null:t; render(); };
    tags.appendChild(s);
  });
}

function renderList(){
  list.innerHTML="";
  let filtered=items;
  if(activeTag) filtered=filtered.filter(i=>i.tags.includes(activeTag));
  if(sortSelect.value==="old") filtered=[...filtered].reverse();
  if(sortSelect.value==="fav") filtered=[...filtered].sort((a,b)=>b.favorite-a.favorite);

  filtered.forEach(i=>{
    const div=document.createElement("div"); div.className="card";
    const img=document.createElement("img"); img.src=i.image; img.onclick=()=>openModal(i);
    const authorDiv=document.createElement("div"); authorDiv.className="author"; authorDiv.textContent=i.author||"";
    const stateDiv=document.createElement("div"); stateDiv.className="state"; stateDiv.textContent=i.state||"";
    div.append(img, stateDiv, authorDiv); list.appendChild(div);
  });
}

/* ===== モーダル ===== */
function openModal(item){
  if(currentItem) modalHistory.push(currentItem);
  currentItem=item;
  modal.style.display="flex";
  modalImage.src=item.image;
  favBtn.textContent=item.favorite?"解除":"お気に入り";
  favBtn.onclick=()=>{ item.favorite=!item.favorite; saveItem(item); openModal(item); render(); };

  editAuthor.value=item.author;
  editAuthor.onchange=()=>{ item.author=editAuthor.value; saveItem(item); render(); };

  modalState.innerHTML="";
  ["","完成","塗り","線画","ラフ","構想"].forEach(s=>{
    const opt=document.createElement("option"); opt.value=s; opt.textContent=s; if(s===item.state) opt.selected=true; modalState.append(opt);
  });
  modalState.onchange=()=>{ item.state=modalState.value; saveItem(item); showNotification(`状態を${modalState.value}に変更`); render(); };

  renderModalTags();
  breadcrumbs.textContent=modalHistory.map(it=>it.date||it.id).join(" > ");

  openUrlBtn.onclick=()=>{ if(item.url) window.open(item.url); };
  deleteBtn.onclick=()=>{ if(confirm("削除しますか？")){ deleteItem(item.id); items=items.filter(x=>x.id!==item.id); closeModal(); render(); } };

  // ズーム＋ドラッグ
  modalImage.style.transform="translate(0px,0px) scale(1)";
  let scale=1, pos={x:0,y:0}, drag={x:0,y:0}, dragging=false;
  modalImage.onmousedown=e=>{ dragging=true; drag.x=e.clientX; drag.y=e.clientY; modalImage.style.cursor="grabbing"; };
  window.onmousemove=e=>{ if(dragging){ const dx=e.clientX-drag.x, dy=e.clientY-drag.y; pos.x+=dx; pos.y+=dy; modalImage.style.transform=`translate(${pos.x}px,${pos.y}px) scale(${scale})`; drag.x=e.clientX; drag.y=e.clientY; } };
  window.onmouseup=e=>{ dragging=false; modalImage.style.cursor="grab"; };
  modalImage.ondblclick=e=>{ scale=scale===1?2:1; modalImage.style.transform=`translate(${pos.x}px,${pos.y}px) scale(${scale})`; };
}

function renderModalTags(){
  modalTags.innerHTML="";
  if(!currentItem||!currentItem.tags) return;
  currentItem.tags.forEach(t=>{
    const s=document.createElement("span"); s.className="tag"; s.textContent=t;
    s.onclick=()=>{ if(confirm(`タグ「${t}」を削除しますか？`)){ currentItem.tags=currentItem.tags.filter(x=>x!==t); saveItem(currentItem); renderModalTags(); render(); } };
    modalTags.appendChild(s);
  });
}

modalTagInput.onkeydown=e=>{
  if(e.key==="Enter"){ const t=modalTagInput.value.trim(); if(t && !currentItem.tags.includes(t)){ currentItem.tags.push(t); saveItem(currentItem); renderModalTags(); render(); } modalTagInput.value=""; }
};

function closeModal(){
  modal.style.display="none";
  currentItem=null;
  modalHistory=[];
}

modal.addEventListener("click",e=>{ if(e.target===modal) closeModal(); });
document.addEventListener("keydown",e=>{ if(e.key==="Escape" && modal.style.display==="flex") closeModal(); });

function showNotification(msg){
  const n=document.getElementById("notification"); n.textContent=msg; n.style.display="block";
  setTimeout(()=>{ n.style.display="none"; },1200);
}
</script>

</body>
</html>

